----------------------------------------------------------------
-- MS1 AUTH - TABLAS
----------------------------------------------------------------

-- USERS
CREATE TABLE USERS (
  ID             NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EXTERNAL_ID    RAW(16) DEFAULT SYS_GUID() NOT NULL,
  USERNAME       VARCHAR2(150) NOT NULL,
  EMAIL          VARCHAR2(200) NOT NULL,
  PASSWORD_HASH  VARCHAR2(255) NOT NULL,
  LAB_CODE       VARCHAR2(50), -- requerido si el rol del usuario es LAB_TECH
  ACTIVE         CHAR(1) DEFAULT 'Y' NOT NULL CHECK (ACTIVE IN ('Y','N')),
  CREATED_AT     TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT     TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT UQ_USERS_USERNAME UNIQUE (USERNAME),
  CONSTRAINT UQ_USERS_EMAIL    UNIQUE (EMAIL),
  CONSTRAINT UQ_USERS_EXTID    UNIQUE (EXTERNAL_ID)
);

-- ROLES
CREATE TABLE ROLES (
  ID           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NAME         VARCHAR2(50) NOT NULL,
  DESCRIPTION  VARCHAR2(255),
  CREATED_AT   TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT   TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT UQ_ROLES_NAME UNIQUE (NAME),
  CONSTRAINT CK_ROLES_UPPER CHECK (NAME = UPPER(NAME))
);

-- USER_ROLES (N..M)
CREATE TABLE USER_ROLES (
  USER_ID     NUMBER NOT NULL,
  ROLE_ID     NUMBER NOT NULL,
  ASSIGNED_AT TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT PK_USER_ROLES PRIMARY KEY (USER_ID, ROLE_ID),
  CONSTRAINT FK_UR_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
  CONSTRAINT FK_UR_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLES(ID) ON DELETE CASCADE
);

----------------------------------------------------------------
-- MS1 AUTH - ÍNDICES
----------------------------------------------------------------
CREATE INDEX IDX_USERS_ACTIVE    ON USERS (ACTIVE);
CREATE INDEX IDX_USERS_LAB_CODE  ON USERS (LAB_CODE);
CREATE INDEX IDX_ROLES_NAME      ON ROLES (NAME);
CREATE INDEX IDX_UR_ROLE_ID      ON USER_ROLES (ROLE_ID);

----------------------------------------------------------------
-- MS1 AUTH - TRIGGERS UPDATED_AT
----------------------------------------------------------------
CREATE OR REPLACE TRIGGER TRG_USERS_UPD
BEFORE UPDATE ON USERS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_ROLES_UPD
BEFORE UPDATE ON ROLES
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

----------------------------------------------------------------
-- MS1 AUTH - SEMILLA (REEMPLAZA HASHES POR BCRYPT REALES)
----------------------------------------------------------------

-- Roles
INSERT INTO ROLES (NAME, DESCRIPTION) VALUES ('ADMIN', 'Administrador');
COMMIT;

INSERT INTO ROLES (NAME, DESCRIPTION) VALUES ('LAB_TECH', 'Técnico de laboratorio');
COMMIT;

-- Usuarios (coloca hashes bcrypt válidos en PASSWORD_HASH)
INSERT INTO USERS (USERNAME, EMAIL, PASSWORD_HASH, LAB_CODE, ACTIVE)
VALUES ('admin@demo.cl', 'admin@demo.cl', '$2a$10$Im8YXm3k8adw84lPI9WPL.Rr1TxESNh94UwdbJ3LuZPfQRn4V1jiG', NULL, 'Y');

INSERT INTO USERS (USERNAME, EMAIL, PASSWORD_HASH, LAB_CODE, ACTIVE)
VALUES ('tec1@demo.cl', 'tec1@demo.cl', '$2a$10$Im8YXm3k8adw84lPI9WPL.Rr1TxESNh94UwdbJ3LuZPfQRn4V1jiG', 'BIOCHECK', 'Y');

select * from users;

INSERT INTO USERS (USERNAME, EMAIL, PASSWORD_HASH, LAB_CODE, ACTIVE)
VALUES ('tec2@demo.cl', 'tec2@demo.cl', '$2a$10$Im8YXm3k8adw84lPI9WPL.Rr1TxESNh94UwdbJ3LuZPfQRn4V1jiG', 'SALUDPLUS_NU', 'Y');


-- Asignación de roles
INSERT INTO USER_ROLES (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM USERS u, ROLES r
 WHERE u.USERNAME = 'admin@demo.cl' AND r.NAME = 'ADMIN';

INSERT INTO USER_ROLES (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM USERS u, ROLES r
 WHERE u.USERNAME = 'tec1@demo.cl' AND r.NAME = 'LAB_TECH';

INSERT INTO USER_ROLES (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM USERS u, ROLES r
 WHERE u.USERNAME = 'tec2@demo.cl' AND r.NAME = 'LAB_TECH';

COMMIT;

